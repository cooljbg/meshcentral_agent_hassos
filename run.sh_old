#!/bin/sh
# run.sh

# Извличане на опциите от /data/options.json
# Този файл се създава автоматично от Home Assistant.
MESH_SERVER_URL=$(jq --raw-output '.mesh_server_url' /data/options.json)
MESH_INSTALL_TOKEN=$(jq --raw-output '.mesh_install_token' /data/options.json)

# Проверка дали стойностите са зададени
if [ -z "$MESH_SERVER_URL" ] || [ -z "$MESH_INSTALL_TOKEN" ]; then
    echo "ERROR: Server URL or install token is not configured. Please check add-on options."
    exit 1
fi

# Изпълняване на инсталационния скрипт с променливите
echo "Downloading and installing MeshCentral Agent from $MESH_SERVER_URL"

wget "$MESH_SERVER_URL/meshagents?script=1" -O ./meshinstall.sh && \
chmod 755 ./meshinstall.sh && \
./meshinstall.sh "$MESH_SERVER_URL" "$MESH_INSTALL_TOKEN"

# Поддържаме контейнера работещ, за да може агентът да работи.
tail -f /dev/null
